<!--
Content-type: Preventing XSRF in IE.

-->
<html><head><link type="text/css" rel="stylesheet" href="/notebook/resources/1553808490-public_css.css">
<title>rails real world</title></head>
<body bgcolor="#FFFFFF" onload=""><link type="text/css" rel="stylesheet" href="/notebook/resources/3158938506-staticpages_css.css">
<table align="center" border="0" cellpadding="5" cellspacing="0" width="100%"><tr valign="middle"><td width="1%"><a href="/notebook/"><img src="/notebook/images/en_notebook_150x55.png" align="left" border="0" height="55" width="150" alt="Google Notebook"></a></td>
<td><table style="margin-bottom: 5px;" align="center" bgcolor="#c3d9ff" border="0" cellpadding="0" cellspacing="0" width="100%" dir="ltr"><tr><td class="bubble tl" align="left" valign="top"><img src="/notebook/images/corner_tl.gif" class="c" alt=""></td>
<td class="bubble1" rowspan="2" style="padding: 3px 0pt; font-family: arial; text-align: left; font-weight: bold; font-size: 100%;">rails real world</td>
<td class="bubble tr" align="right" valign="top"><img src="/notebook/images/corner_tr.gif" class="c" alt=""></td></tr>
<tr><td class="bubble bl" align="left" valign="bottom"><img src="/notebook/images/corner_bl.gif" class="c" alt=""></td>
<td class="bubble br" align="right" valign="bottom"><img src="/notebook/images/corner_br.gif" class="c" alt=""></td></tr></table></td></tr></table>
<br>
<div id="pubContent"><div id="pubHeader"><div id="pubHeaderSub">Last edited  June 23, 2007 
<br></div></div>

<a name="NDQVSDQoQm8KiiPEj"></a>
<div class="PubNote">
<div class="PubNoteContentArea"> From old paginatation:<br><br>@users_pages, @users = paginate(:users, :page =&gt; x, :per_page =&gt; y, :conditions =&gt; ...)<br>&lt;%= pagination_links @pages %&gt;<br><br>to new will_paginate:<br><br>@users = User.paginate(:page =&gt; x, :per_page =&gt; y, :conditions =&gt; ...)<br>&lt;%= will_paginate @users %&gt;<br></div>
</div> <a name="NDRKWDAoQg_rB9-Ej"></a>
<div class="PubNote">
<div class="PubNoteContentArea">dynamic select with Ajax, there is a railscast that shows a javascript client side way, here I talk about Ajax ways...<br><br>Two ways I will document here, the first is likely the more &quot;rails&quot; way, and has to do with sticking a remote function on the first selects onchange event.  Although this is the rails way, it would be harder to customize as the details are hidden from you:<br>--------------------------------------------------------------------------------------------------------------------------------------<br>First the view containing the two selects:<br><br>&lt;dl class=&quot;form clearfix&quot;&gt;<br>    &lt;dt&gt;&lt;%= f.label :description %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.text_field :description %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :overlay_type_id %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.select :overlay_type_id, OverlayType.options_for_select, :include_blank =&gt; true %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :workflow_taskable_type, &#39;Assigned to Type&#39; %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.select :workflow_taskable_type, WorkflowTask.workflow_taskable_types, {:include_blank =&gt; true}, :onchange =&gt; &quot;#{remote_function(:update =&gt; &#39;workflow_taskable_options&#39;, :url =&gt; update_workflow_taskable_options_unit_operation_order_workflow_tasks_path(@unit, @operation_order), :method =&gt; :get, :with =&gt; &quot;&#39;workflow_taskable_type=&#39;+value&quot;, :before =&gt; &#39;GlobalWorking.show();&#39;, :complete =&gt; &#39;GlobalWorking.hide();&#39;)}&quot; %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :workflow_taskable_id, &#39;Assigned to&#39; %&gt;&lt;/dt&gt;<br>    &lt;dd&gt;<br>        &lt;div id=&quot;workflow_taskable_options&quot;&gt;<br>            &lt;%= render :partial =&gt; &#39;workflow_taskable_options&#39;,<br>                :locals =&gt; {:type =&gt; @workflow_task.workflow_taskable_type,<br>                            :unit =&gt; @unit,<br>                            :selected =&gt; (@workflow_task.workflow_taskable) ? @<a href="http://workflow_task.workflow_taskable.id">workflow_task.workflow_taskable.id</a> : nil} %&gt;<br>        &lt;/div&gt;<br>    &lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :complete %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.check_box :complete %&gt;&lt;/dd&gt;<br>&lt;/dl&gt;<br><br>So the second select is rendered from a partial, here it is:<br><br>&lt;%= select_tag &#39;workflow_task[workflow_taskable_id]&#39;,<br>    options_for_select(WorkflowTask.possible_workflow_taskables_options_for_select(type, unit), selected),<br>    :include_blank =&gt; true %&gt;<br><br>And the onchange hits a controller method, here it is:<br><br>  def update_workflow_taskable_options<br>
    workflow_taskable_type = params[:workflow_taskable_type]<br>
    render :partial =&gt; &#39;workflow_taskable_options&#39;,<br>
           :locals =&gt; {:type =&gt; workflow_taskable_type,<br>
                       :unit =&gt; @unit,<br>
                       :selected =&gt; nil}<br>
  end<br>--------------------------------------------------------------------------------------------------------------------------------------<br>The second way gives you better control, and only moves the options array across the wire instead of sending an entire partial view snippet.  First, the view has some javascript in it to hook the onchange and react accordingly - either blanking the select out or fetching the options:<br><br><br>&lt;dl class=&quot;form clearfix&quot;&gt;<br>    &lt;dt&gt;&lt;%= f.label :description %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.text_field :description %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :overlay_type_id %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.select :overlay_type_id, OverlayType.options_for_select, :include_blank =&gt; true %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :workflow_taskable_type, &#39;Assigned to Type&#39; %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.select :workflow_taskable_type, WorkflowTask.workflow_taskable_types, :include_blank =&gt; true %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :workflow_taskable_id, &#39;Assigned to&#39; %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.select :workflow_taskable_id, WorkflowTask.possible_workflow_taskables_options_for_select(@workflow_task.workflow_taskable_type, @unit), :include_blank =&gt; true %&gt;&lt;/dd&gt;<br>    &lt;dt&gt;&lt;%= f.label :complete %&gt;&lt;/dt&gt;&lt;dd&gt;&lt;%= f.check_box :complete %&gt;&lt;/dd&gt;<br>&lt;/dl&gt;<br>&lt;script&gt;<br>$(&quot;workflow_task_workflow_taskable_type&quot;).observe(&quot;change&quot;, function(evt) {<br>  var workflowTaskableType = $F(evt.element());<br>  var select = $(&quot;workflow_task_workflow_taskable_id&quot;);<br>  if (workflowTaskableType == &quot;&quot;) {<br>    Camber.setSelectOptions(select, [], true);<br>  } else {<br>    // perhaps should switch to Ajax.Responders global listeners for this show<br>    // hide working stuff.<br>    Camber.showWorking();<br>    new Ajax.Request(&#39;&lt;%= possible_workflow_taskables_unit_operation_order_workflow_tasks_path(@unit, @operation_order) %&gt;&#39;, {<br>      method: &#39;GET&#39;,<br>      parameters: {workflow_taskable_type: workflowTaskableType},<br>      onSuccess: function(transport) {<br>        Camber.setSelectOptions(select, transport.responseJSON, true);<br>      },<br>      onFailure: function(transport) {alert(transport.responseText);},<br>      onComplete: function(transport) {Camber.hideWorking();}<br>    });<br>  }<br>});<br>&lt;/script&gt;<br><br>Note that it relies on a Camber namespaced method setSelectOptions which is shown here:<br><br>var Camber = {<br>    setSelectOptions: function(select, options, includeBlank) {<br>        select.options.length = 0;<br>        if (includeBlank) options.unshift([&quot;&quot;, &quot;&quot;]);<br>        this.appendSelectOptions(select, options);<br>    },<br>    appendSelectOptions: function(select, options) {<br>        for (var i = 0, l = options.length; i &lt; l; ++i) {<br>            var option = new Option(options[i][0], options[i][1]);<br>            select.options[select.options.length] = option;<br>        }<br>    }<br>}<br><br>Now in the controller we only have to send back the JSON for the options to display, that controller method is here:<br><br>  def possible_workflow_taskables<br>    workflow_taskable_type = params[:workflow_taskable_type]<br>    options = WorkflowTask.possible_workflow_taskables_options_for_select(workflow_taskable_type, @unit)<br>    render :json =&gt; options<br>  end<br></div>
</div> <a name="NDQVSDQoQ2Jf4zeEj"></a>
<div class="PubNote">
<div class="PubNoteContentArea">has_many :through and collection_singular_ids= apparently still works<br><br>If you are doing a has_many :through and aren&#39;t setting any data in the join model then you can set up the association by using the collection_singular_ids= on the joined model.  For example I had:<br><br>EduClass -&gt; Instructorships &lt;- User<br><br>To indicate instructors.  This can be set up correctly using edu_class.instructor_ids = [an array of ids], it will correctly delete and add as needed.<br><br>So the web page merely needed to be able to correctly send edu_class[instructor_ids][] back to the controller (mine did an autocomplete that put hidden field tags into the page with the proper name.  See app/views/edu_classes/_form.rhtml for this code pasted in below).  On the controller end it picks it up perfectly with on caveat, you need to send an empty array if they did not, otherwise instructor_ids= will not be invoked.  So you get this:<br><br>params[:edu_class][:instructor_ids] ||= []<br><br>This code is in TACT.<br><br>Now if you are storing data in the join model you can&#39;t do it this easy way!  Then you need to go the full blown instructorship_attributes= route which can best be seen in the railscast for the complex forms.<br><br><br><br><br>&lt;table&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;label for=&quot;edu_class_name&quot;&gt;Name:&lt;/label&gt;&lt;/td&gt;<br>        &lt;td&gt;&lt;%= f.text_field :name %&gt;&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;label for=&quot;edu_class_section&quot;&gt;Section:&lt;/label&gt;&lt;/td&gt;<br>        &lt;td&gt;&lt;%= f.text_field :section %&gt;&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;label for=&quot;edu_class_starting&quot;&gt;Start:&lt;/label&gt;&lt;/td&gt;<br>        &lt;td&gt;&lt;%= f.calendar_date_select :starts_at, :size =&gt; 20, :time =&gt; :true %&gt;&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;label for=&quot;edu_class_ending&quot;&gt;End:&lt;/label&gt;&lt;/td&gt;<br>        &lt;td&gt;&lt;%= f.calendar_date_select :ends_at, :size =&gt; 20, :time =&gt; :true %&gt;&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;Instructors:&lt;/td&gt;<br>        &lt;td&gt;<br>            &lt;%= text_field_tag &#39;instructor&#39;, &#39;&#39;, :autocomplete =&gt; &#39;off&#39; %&gt;<br>            &lt;div id=&quot;instructor_auto_complete&quot; class=&quot;auto_complete&quot;&gt;&lt;/div&gt;<br>            &lt;%= hidden_field_tag &#39;instructor_id&#39; %&gt;<br>            &lt;input type=&quot;button&quot; value=&quot;Add&quot; id=&quot;add_instructor&quot; disabled=&quot;disabled&quot;/&gt;<br>        &lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;/td&gt;<br>        &lt;td&gt;<br>            &lt;ul id=&quot;instructors&quot; class=&quot;naked&quot;&gt;<br>                &lt;% @edu_class.instructors.each do |instructor| -%&gt;<br>                        &lt;li&gt;<br>                            &lt;%= <a href="http://instructor.name">instructor.name</a> %&gt;&lt;%= hidden_field_tag &#39;edu_class[instructor_ids][]&#39;, <a href="http://instructor.id">instructor.id</a> %&gt;<br>                            &lt;a href=&quot;#&quot;&gt;remove&lt;/a&gt;<br>                        &lt;/li&gt;<br>                &lt;% end -%&gt;<br>            &lt;/ul&gt;<br>        &lt;/td&gt;<br>    &lt;/tr&gt;<br>&lt;/table&gt;<br>&lt;script&gt;<br>var instructorAutoCompleter = new Ajax.Autocompleter(&quot;instructor&quot;,<br>    &quot;instructor_auto_complete&quot;, &quot;/edu_classes/possible_instructors&quot;,<br>    {method: &quot;GET&quot;, updateElement: function(li) {storeSelection(li);}});<br><br>function storeSelection(li) {<br>  var instructor = class2content(&quot;name&quot;, li);<br>  var id = class2content(&quot;id&quot;, li);<br>  $(&quot;instructor&quot;).value = instructor;<br>  $(&quot;instructor_id&quot;).value = id;<br>  $(&quot;add_instructor&quot;).enable();<br>}<br><br>function addInstructor() {<br>  var str = &#39;&lt;li&gt;#{name}&#39;;<br>  str += &#39;&lt;input type=&quot;hidden&quot; name=&quot;edu_class[instructor_ids][]&quot; value=&quot;#{id}&quot;/&gt;&#39;;<br>  str += &#39; &lt;a href=&quot;#&quot;&gt;remove&lt;/a&gt;&#39;<br>  str += &#39;&lt;/li&gt;&#39;;<br>  var template = new Template(str);<br>  var fields = {name: $F(&quot;instructor&quot;), id: $F(&quot;instructor_id&quot;)};<br>  $(&quot;instructors&quot;).insert(template.evaluate(fields));<br>}<br><br>$(&quot;add_instructor&quot;).observe(&quot;click&quot;, function(evt) {<br>  $(&quot;add_instructor&quot;).disable();<br>  addInstructor();<br>  $(&quot;instructor&quot;).value = &quot;&quot;;<br>});<br><br>$(&quot;instructor&quot;).observe(&quot;keydown&quot;, function(evt) {<br>  $(&quot;add_instructor&quot;).disable();<br>});<br><br>$(&quot;instructors&quot;).observe(&quot;click&quot;, function(evt) {<br>  var target = evt.element();<br>  if (target.tagName == &quot;A&quot;) target.up(&quot;li&quot;).remove();<br>});<br>&lt;/script&gt;<br><br></div>
</div> <a name="NDQ1tIgoQzJiM8_gi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Better nested set, betternestedset, provides a handy model method called full_set that returns a node and all its descendants in an ordered array that makes it pretty painless to build something like an indented messaging posting list.  It does this by returning the array in an order that has the message followed by its children with a level field indicating the depth in the tree.  Thus you can &quot;indent&quot; some value times the level and get it laid out correctly.  In some cases you may want to convert this array into the actual nested version of the data structure, that is, instead of the children following the parent in a flat array, the children are available as a field of the parent in a children array.  You can then convert this structure to json for usage in something like an extjs tree control.  Here is some mighty slick code to do that conversion to the hierarchical data structure:<br><br>  # returns hierarchical data structure rooted at this node, when converting to<br>  # json make sure to remove :parent to avoid circular reference:<br>  # goo_message.hierarchy.to_json(:only =&gt; [:id, :subject, :children, ...])<br>  def hierarchy<br>    the_full_set = full_set<br>    ancestry = [build_node(the_full_set.shift)]<br>    while !the_full_set.empty?<br>      next_node = build_node(the_full_set.shift)<br>      while next_node[:level] &lt;= ancestry.last[:level]<br>        ancestry.pop<br>      end<br>      ancestry.last[:children] &lt;&lt; next_node<br>      ancestry.last[:leaf] = false<br>      next_node[:parent] = ancestry.last<br>      ancestry &lt;&lt; next_node<br>    end<br>    ancestry[0]<br>  end<br><br>  # active record GooMessage to node for hierarchy<br>  def build_node(goo_message)<br>    ret = {}<br>    ret[:id] = goo_message.id<br>    ret[:subject] = goo_message.subject<br>    ret[:message] = goo_message.message<br>    ret[:level] = goo_message.level<br>    ret[:children] = []<br>    ret[:parent] = nil<br>    ret[:leaf] = true<br>    ret<br>  end<br></div>
</div> <a name="NDSUCIwoQ0Y2Q0_gi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Helpers that wrap:<br><br>  def wrap_it(&amp;block)<br>    concat(&#39;before&#39;, block.binding)<br>    concat(capture(&amp;block), block.binding)<br>    concat(&#39;after&#39;, block.binding)<br>  end<br><br>use like this:<br><br>&lt;% wrap_it do %&gt;<br>hello world content<br>&lt;% end %&gt;<br></div>
</div> <a name="NDSS8IgoQ_bfl_a0i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Model objects have constructors that take hashes so that these work:<br><br>@order = Order.new(params[:order])<br><br><br>In order to change the Order object from keeping a pay_type string with static arrays in Orders::PAYMENT_TYPES to using a payment_type_id referring to a payment_types table:<br><br>01. ======================================================================<br>    Create the payment_types table migration<br>    ======================================================================<br>class CreatePaymentTypes &lt; ActiveRecord::Migration<br><br>  def self.up<br>    create_table :payment_types do |t|<br>      t.column :display_text, :string<br>    end<br>  end<br><br>  def self.down<br>    drop_table :payment_types<br>  end<br><br>end<br><br>02. ======================================================================<br>    Populate some payment_types migration<br>    ======================================================================<br>class AddPaymentTypes &lt; ActiveRecord::Migration<br>  def self.up<br>    PaymentType.create :display_text =&gt; &#39;Check&#39;<br>    PaymentType.create :display_text =&gt; &#39;Credit Card&#39;<br>    PaymentType.create :display_text =&gt; &#39;Purchase Order&#39;<br>  end<br><br>  def self.down<br>    PaymentType.delete_all<br>  end<br>end<br><br>03. ======================================================================<br>    Modify orders migration to hold a payment_type_id<br>    ======================================================================<br>class ChangeOrdersPaymentType &lt; ActiveRecord::Migration<br>  def self.up<br>    remove_column :orders, :pay_type<br>    add_column :orders, :payment_type_id, :integer, :null =&gt; false<br><br>    execute &quot;ALTER TABLE orders<br>               ADD CONSTRAINT fk_orders_payment_type<br>               FOREIGN KEY (payment_type_id) REFERENCES payment_types(id)&quot;<br>  end<br><br>  def self.down<br>    execute &quot;ALTER TABLE orders DROP FOREIGN KEY fk_orders_payment_type&quot;<br><br>    remove_column :orders, :payment_type_id<br>    add_column :orders, :pay_type, :string, :limit =&gt; 10<br>  end<br><br>end<br><br>04. ======================================================================<br>    Modify relationships in PaymentType and Order<br>    ======================================================================<br>class PaymentType &lt; ActiveRecord::Base<br><br>  has_many :orders<br><br>end<br><br>class Order &lt; ActiveRecord::Base<br><br>  has_many :line_items<br>  # orders holds the foreign key so belongs to<br>  belongs_to :payment_type<br><br>  ...<br><br>05. ======================================================================<br>    checkout.rhtml writes out select<br>    ======================================================================<br>&lt;label for=&quot;order_payment_type_id&quot;&gt;Pay With:&lt;/label&gt;<br>&lt;%= form.select :payment_type_id,<br>    PaymentType.find(:all).collect {|p| [p.display_text, <a href="http://p.id">p.id</a>]},<br>    :prompt =&gt; &quot;Select a payment method&quot; %&gt;<br><br>06. ======================================================================<br>    modify validation in order.rb<br>    ======================================================================<br>validates_presence_of :name, :address, :email, :payment_type_id<br>validates_inclusion_of :payment_type_id,<br>  :in =&gt; PaymentType.find(:all).collect {|p| <a href="http://p.id">p.id</a>}<br><br></div>
</div> <a name="NDQWiSwoQjKa32rUi"></a>
<div class="PubNote">
<div class="PubNoteContentArea"> Interestingly the AOR books says that element proxy method names are automatically converted into the proper camel case.  For example, this:<br><br>page[:identifier].selected_index = 5<br><br>Should result in this javascript being thrown back at the page:<br><br>$(&#39;identifier&#39;).selectedIndex = 5<br><br>However, I found this not to be the case.  It seems that this only works for the Prototype defined methods, not for general javascript properties.  Using firebug I could see that rails was writing back:<br><br>$(&#39;identifier&#39;).selected_index = 5;<br><br>Which isn&#39;t correct.  So I had to change the rjs call to using the camel case:<br><br>page[:identifier].selectedIndex = 5<br><br>So did the AOR book mean to say that the camel case conversions only work for Prototype methods?  Or is it only static methods?<br></div>
</div> <a name="NDR-OIgoQuamurbYi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">In order to do validations of your own you have to look at the *_before_type_cast values, otherwise, you may be looking at values that were already coerced. </div>
</div> <a name="NDQWiSwoQ3KbFsLYi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Needs to be generalized into a validator:<br><br>def validate<br>  if !errors.on(:required_count) &amp;&amp; required_count &lt; 1<br>    errors.add(:required_count, &#39;must be greater than 0&#39;)<br>  end<br>end<br></div>
</div> <a name="NDQjbSwoQwfil_7Yi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Count with an aggregate field, wrong way:<br><br>def unit_resource_category_names_with_counts<br>  UnitResource.count(:conditions =&gt; [&#39;unit_id = ?&#39;, id],<br>                                :include =&gt; {:resource =&gt; [:resource_category]},<br>                                :group =&gt; &#39;resources.resource_category_id, resource_categories.name&#39;,<br>                                :order =&gt; &#39;count_all&#39;)<br>end<br><br>Suprise, returns [[&quot;personel&quot;, 5], [&quot;equipment&quot;, 2]]<br><br>Better way:<br><br>unit_resources = UnitResource.find_by_sql(&quot;SELECT rc.*, COUNT(rc.id) AS count FROM units u&quot;<br>    + &quot; INNER JOIN unit_resources ur ON u.id = ur.unit_id&quot;<br>    + &quot; INNER JOIN resources r ON ur.resource_id = r.id&quot;<br>    + &quot; INNER JOIN resource_categories rc ON r.resource_category_id = rc.id&quot;<br>    + &quot; WHERE u.id = #{@unit.id}&quot;<br>    + &quot; GROUP BY rc.id&quot;<br>    + &quot; ORDER BY count DESC;&quot;)<br><br>Now get the full object allong with the count in a count field.<br></div>
</div> <a name="NDQ6YIgoQxoegibci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">page[:div].reload is the bomb.  With proper naming it will reload the corresponding partial using an ajax call.  If not named properly can use the same parameters as when you do render :partial, such as:<br><br>page[:unit_resources].reload :object =&gt; @unit.unit_resources <br></div>
</div> <a name="NDQSkIwoQjcnGgrgi"></a>
<div class="PubNote">
<div class="PubNoteContentArea"><span>:dependent =&gt; :protect<br><br>On 6/26/07, David Burger &lt;<a href="mailto:loosedog@gmail.com">loosedog@gmail.com</a>&gt; wrote:<br>&gt; Hello, I&#39;m writing about your :dependent =&gt; :protect plugin.  I don&#39;t<br>&gt; think this plugin works in practice because multiple threads of<br>&gt; execution could be running against the database at the same time.  For<br>&gt; example, say you are running a setup with Parent and Child tables<br>&gt; where you are not supposed to delete the Parent if it has a Child.<br>&gt; Then in the parent it would be:<br>&gt;<br>&gt; class Parent<br>&gt;<br>&gt;   has_many :children, :dependent =&gt; :protect<br>&gt;<br>&gt;   ...<br>&gt;<br>&gt; end<br>&gt;<br>&gt; Now say you have you have a Parent with no children and requests come<br>&gt; in at very close to the same time to delete the Parent and to add a<br>&gt; Child to that same Parent.  Say the threading of execution works out<br>&gt; so that the check for a child happens, which says there are no<br>&gt; children, and then the execution switches to adding a child, finishes<br>&gt; adding the child, and the threading switches back to deleting the<br>&gt; parent, which now shouldn&#39;t be deleted because it now has a child.<br>&gt;<br>&gt; Can&#39;t this only be solved reliably by adding the foreign key<br>&gt; constraint in the database?  Isn&#39;t it possible for this plugin to fail<br>&gt; based on my describe race condition?<br>&gt;<br>&gt; thanks,<br>&gt; djb<br>&gt;<br><br></span>Yes, I think that the situation you describe can occur. Rails is not<br>aware of other processes (other Rails) accessing the database so<br>situations like the one you describe can happen (and if Murphy is<br>right, they will happen). It&#39;s the same when you update some record<br>from two different processes nearly at the same time, the second<br>update wins.<br><br>I don&#39;t&#39; think of a way of making it bulletproof, I think many of<br>ActiveRecord trust that the situations we&#39;ve described never (or<br>almost never) happen.<br><br>The foreign key constraint in the database is the way to go, but not<br>all databases support it the same way, and Rails seems to not like<br>giving the RDBMS so much work. Many things in Rails reinvent many<br>functionality present in modern RDBMS only because core Rails<br>developers like it that way. I write the plugin because all options<br>for &quot;ON DELETE&quot; SQL clause seems to be supported except the one I use<br>more: &quot;ON DELETE RESTRICT&quot;, which Rails developers don&#39;t like very<br>much (&lt;<a href="http://dev.rubyonrails.org/ticket/3837">http://dev.rubyonrails.org/ticket/3837</a>&gt;).<br><br>Recently I came across another plugin which offers much more the same<br>functionality as mine<br>&lt;<a href="http://www.stephenbartholomew.co.uk/2007/6/22/dependent-raise">http://www.stephenbartholomew.co.uk/2007/6/22/dependent-raise</a>&gt;, and a<br>fast look to the code shows that it reaches more or less the same<br>solution.<br><br>My way to go is to enforce the constraint in all the places I can: I<br>enforce it in the UI by not creating the destroy link if the record<br>has children, I enforce it in the model using my plugin, and I enforce<br>it in the database with foreign key constraints if I can use them.<br>It&#39;s a PITA, but I sleep easily if I do it that way.<br><br>Hope I&#39;ve answered your questions.<br>Bye.</div>
</div> <a name="NDQKYIgoQu8Kxybsi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">By scoping your creates you can make your code cleaner and let rails do some wiring for you.  For example, if you have a User object that has_many :recipes then you can do:<br><br>@user.recipes.create(params[:recipe])<br>@user.recipes.build(params[:recipe])<br><br>Both of these variants will return the newly created recipe.  The difference is that the first case will also save the record while the second will not.  You probably always want to use the second because of what happens if the new recipe fails validation.  In the first case the recipe is not saved but the new_record? property will be true.  In the second case you are merely handed a Recipe that you need to save anyway so it is much more natural to do it like this:<br><br>recipe = @user.recipes.build(params[:recipe])<br>if recipe.save<br>  # probably redirect<br>end<br></div>
</div> <a name="NDQgjIgoQ_tbcybsi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">To get ActiveRecord to use UTC based time instead of local time you need to uncomment:<br><br>  # config.active_record.default_timezone = :utc<br><br>in config/environment.rb<br></div>
</div> <a name="NDRKQSgoQx9T0ur0i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">In functional tests I don&#39;t seem to be able to get a hold of the created model objects to figure out the errors placed within the object instance to determine if valid so went with a second best of looking at the returned page for the div that errors are put in by using assert_select:<br><br>assert_select &#39;#errorExplanation&#39;<br></div>
</div> <a name="NDQGMIgoQouqR6sYi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">In functional tests can test against some of the standard objects like flash, for example, a regexp test:<br><br>assert_match /Whatever/, flash[:notice]<br></div>
</div> <a name="NDSOeIgoQj7GEqcIi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Some  AJAX remote loading of a div based on a select box change:<br><br>&lt;select id=&quot;the_select&quot; onchange=&quot;&lt;%= remote_function(:update =&gt; &#39;the_div&#39;, :url =&gt; {:action =&gt; :option_change}, :with =&gt; &quot;&#39;value=&#39; + $(&#39;the_select&#39;).value&quot;) %&gt;&quot;&gt;<br>  &lt;option value=&quot;0&quot;&gt;0&lt;/option&gt;<br>  &lt;option value=&quot;1&quot;&gt;1&lt;/option&gt;<br>  &lt;option value=&quot;2&quot;&gt;2&lt;/option&gt;<br>&lt;/select&gt;<br>&lt;div id=&quot;the_div&quot;&gt;&lt;/div&gt;<br><br>On the server the def option_change can get params[:value] and render a partial back into the div.  Here we just render the value back:<br><br>def option_change<br>  render :text =&gt; params[:value]<br>end<br></div>
</div> <a name="NDQ3RIgoQzJWdwcMi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">If you want to render some html into the flash the best way might be:<br><br>flash[:notice] = render_to_string :inline =&gt; &#39;Thing created.  &lt;% link_to &#39;Edit&#39;, :action =&gt; :edit %&gt;&#39;<br><br>nah, probably should render_to_string a partial to keep the view in the view.<br></div>
</div> <a name="NDQGkIwoQ9aG5_Mki"></a>
<div class="PubNote">
<div class="PubNoteContentArea"><font face="arial,sans-serif">Some of the capistrano commands need to be done sudo and also must change to a certain directory before executing.  Because cp is a built it, it can&#39;t be run under sudo.  Instead, you can compose the command by delegating to sh as follows: </font><pre><font face="courier new,monospace" size="2">sudo &lt;&lt;-CMD<br>  sh-c &quot;cd #{current_path} &amp;&amp; nohup mongrel_rails start &gt;/dev/null&quot;<br>CMD</font></pre></div>
</div> <a name="NDRmeIwoQh-G-_Mki"></a>
<div class="PubNote">
<div class="PubNoteContentArea"><font face="arial,sans-serif" size="2">When mongrel is running behind Apache it won&#39;t know when a request is received whether or not it was originally sent over http or https.  This causes problems when Rails does things like create redirects.  Fortunately, if you put the right header into the request that Apache forwards to Rails, Rails will recognize it and identify the request correctly as http or https.  The rule that writes this header is as follows:<br><br></font><font face="arial,sans-serif" size="2">RequestHeader set X_FORWARDED_PROTO &#39;https&#39;<br><br>This, of course, goes in the appropriate Apache .conf file.  Such as in the:<br><br>&lt;VirtualHost *:443&gt;<br></font><font face="arial,sans-serif" size="2">  RequestHeader set X_FORWARDED_PROTO &#39;https&#39;</font><br><font face="arial,sans-serif" size="2">&lt;/VirtualHost&gt;<br><br>Now if you are putting this in a .common file that is included in both the *:80 and *443 sections then you can put it like this:<br><br>RequestHeader set X_FORWARDED_PROTO &#39;https&#39; env=HTTPS<br><br>and then I assume it will not add the header under *:80 but will under *:443 although I haven&#39;t been able to test this yet.<br></font></div>
</div> <a name="NDQzjIgoQl7Lo8soi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">When running in development mode there are two very important config settings that are going to effect how things run:<br><br>1. config.cache.classes = true | false<br>2. config.action_controller.consider_all_requests_local = true | false<br><br>The first of these has a very big impact because constant class reloading under development means that CLASS VARIABLES ARE OFTEN LOST.  An example is the class variables that may be set by code in config/environment.rb.  Of course if you turn this to false then your dev environment is a pain in the ass because you have to restart your server all the time to see changes.  You don&#39;t want to do that.<br><br>The second of these has a large impact because some features are on / off depending on the value of considering requests local.  For example a class like ExceptionNotifier doesn&#39;t send emails on exceptions when the request is local, which is good for 127.0.0.1 but may not be what you want if you have a deployed version running in dev mode.  That deployed version should probably be running production so that you get the notifications.  Another area that uses this flag is the rescue global or local...local will give stack trace, global will give less detail on exception.<br></div>
</div> <a name="NDSDWIgoQ6N-js84i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">How to replace a series of checkboxes as displayed by ActiveScaffold with a series of check boxes for the selected ones and a select box to add another:<br><br>   def attribute_groups_form_column(record, input_name)<br>    content = &#39;&#39;<br>    num_attribute_groups = record.attribute_groups.count<br>    content += javascript_tag(&quot;numAttributeGroups = #{num_attribute_groups};&quot;)<br>    record.attribute_groups.each_with_index do |ag, i|<br>      content += check_box_tag(&quot;#{input_name}[#{i}][id]&quot;, <a href="http://ag.id">ag.id</a>, true) + content_tag(:label, <a href="http://ag.name">ag.name</a>)<br>    end<br>    content += content_tag(:div, &#39;&#39;, :id =&gt; &#39;butter&#39;)<br>    jscript = &lt;&lt;-EOJS<br>      var checkBox = document.createElement(&#39;input&#39;);<br>      checkBox.type = &#39;checkbox&#39;;<br>      checkBox.name = &#39;record[attribute_groups][&#39; + ++numAttributeGroups + &#39;][id]&#39;;<br>      checkBox.value = $(&#39;foo&#39;).value;<br>      checkBox.checked = true;<br>      $(&#39;butter&#39;).appendChild(checkBox);<br>      $(&#39;butter&#39;).appendChild(document.createTextNode(&#39;ooooo&#39;));<br>    EOJS<br>    content += button_to_function(:foo, jscript)<br>    options = AttributeGroup.find(:all).map {|ag| [<a href="http://ag.name">ag.name</a>, <a href="http://ag.id">ag.id</a>]}<br>    content += select_tag(&#39;foo&#39;, options_for_select(options))<br>  end<br><br><br>or in case of new dog:<br><br>  def subordinates_form_column(record, input_name)<br>    content = &#39;&#39;<br>    num_subordinates = record.subordinates.count<br>    content += javascript_tag(&quot;numSubordinates = #{num_subordinates};&quot;)<br>    record.subordinates.each_with_index do |s, i|<br>      content += check_box_tag(&quot;#{input_name}[#{i}][id]&quot;, <a href="http://s.id">s.id</a>, true) +<br>          content_tag(:label, link_to(s.uic, :controller =&gt; &#39;admin/units&#39;, :action =&gt; :edit, :id =&gt; <a href="http://s.id">s.id</a>))<br>    end<br>    content += content_tag(:div, &#39;&#39;, :id =&gt; &#39;new_subordinates&#39;)<br>    javascript = &lt;&lt;-EOJS<br>      var checkBox = document.createElement(&#39;input&#39;);<br>      checkBox.type = &#39;checkbox&#39;;<br>      checkBox.name = &#39;record[subordinate_id][&#39; + ++numSubordinates + &#39;][id]&#39;;<br>      checkBox.value = 1;<br>      checkBox.checked = true;<br>      $(&#39;new_subordinates&#39;).appendChild(checkBox);<br>      $(&#39;new_subordinates&#39;).appendChild(document.createTextNode(&#39;oooooo&#39;));<br>    EOJS<br>    options = Unit.find(:all).map {|u| [u.short_name, <a href="http://u.id">u.id</a>]}<br>    content += select_tag(:foo, options_for_select(options))<br>    content += button_to_function(&#39;Add&#39;, javascript)<br>    content<br>  end<br></div>
</div> <a name="NDSfhIgoQ1pjm3vYi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Deploying for the first time on tsunami:<br><br>1. manually create the deploy directory in /var/www, chown to dburger:developers<br>2. cap deploy:setup<br>3. cap -q deploy:check<br>4. fix up database.yml &amp; database on the server<br>5. cap deploy:cold<br></div>
</div> <a name="NDQlHIgoQldKl3vYi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Wrote a plugin called session_scrubber that scrubbed sessions out of the database.  Problem is, the plugin needs to know if the app is being run with :local or :utc time.  This method will allow you to determine the correct one on the fly:<br><br>  def to_database_time(time)<br>    (ActiveRecord::Base.default_timezone == :utc) ? time.send(:utc) : time<br>  end<br></div>
</div> <a name="NDQsiIgoQp8SFtM4i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">For validation on booleans,  need to used validates_inclusion_in, because validates_presence_of<br>will not work with false.  It is noted in the rails docs.<br></div>
</div> <a name="NDSLwIgoQmamXw84i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Looking for a way to delete all but the last five deploys led me to this:<br><br>ls -1t | sed -n &#39;6,${p}&#39; | xargs rm -rf<br><br>which is a clever command line way to order by date, skip the first five, and pipe the rest into rm.  I was going to add a sudo or run of these to our capistrano scripts.  Of course then I found that capistrano has this:<br><br>cap deploy::cleanup<br><br>Leaves the last 5.<br></div>
</div> <a name="NDQ9iSgoQ8o3Tg9Ei"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Sometimes you need to do migrations that involve adding / deleting records to make the existing database valid under a new strategy you are using.  An example of this is the change I made where each Resource object now needed to have a private AttributeGroup, indicated by the new value public = false in the AttributeGroup model.  So the migration not only needed to add the boolean public field to the attribute_groups table but also needed to add the private AttributeGroup for each existing resource.  The Resource entity is linked to it AttributeGroups though the join table resources_attribute_groups, so I needed to add entries to both tables and somehow keep track of which resources_attribute_group went with which attribute_group.  I couldn&#39;t add to resources_attribute_groups first because that entry needs the attribute_group_id value from the attribute_groups table.  Thus I needed to add the records to attribute_groups first but how to keep track of which AttributeGroup went with which ResourcesAttributeGroup?  I came up with a clever way of doing this that involved adding a resource_id column temporarily to the attribute_groups table so I could keep track of which records were being matched.  After I linked everything up I dropped the resource_id column.  The SQL is here (of course in execute &quot;&quot; in Rails migrations):<br><br>ALTER TABLE attribute_groups ADD COLUMN resource_link_id int;<br><br>INSERT INTO attribute_groups (name, public, resource_id)<br>    SELECT CONCAT_WS(&#39; &#39;, name, &#39;Attributes&#39;, UNIX_TIMESTAMP()), 0, id<br>    FROM resources WHERE id NOT IN<br>    (SELECT <a href="http://r.id/">r.id</a> FROM resources r LEFT JOIN resources_attribute_groups rag<br>        ON <a href="http://r.id/">r.id</a> = rag.resource_id LEFT JOIN attribute_groups ag ON<br>        rag.attribute_group_id = <a href="http://ag.id/">ag.id</a> WHERE public = 0);<br><br>INSERT INTO resources_attribute_groups (resource_id, attribute_group_id)<br>    SELECT <a href="http://r.id/">r.id</a>, <a href="http://ag.id/">ag.id</a> FROM resources r JOIN<br>    attribute_groups ag ON <a href="http://r.id/">r.id</a> = ag.resource_id;<br><br>ALTER TABLE attribute_groups DROP COLUMN resource_id;<br><br>How to do this stumped me for a while because I wasn&#39;t thinking outside the box enough to consider this temporary column solution.<br></div>
</div> <a name="NDSLwIgoQqcSt2dMi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">I&#39;ve found some of the Array methods to be very handy to put together sql with sql bind parameters.  First an example where the sql generated is only the conditions:<br><br>  def conditions_for_unit_resources<br>    conditions = []<br>    conditions &lt;&lt; [&#39;unit_resources.unit_id = ?&#39;, @<a href="http://unit.id/">unit.id</a>]<br>    conditions &lt;&lt; [&#39;unit_resources.parent_id IS NULL&#39;]<br>    if @rcid<br>      conditions &lt;&lt; [&#39;resource_category_id = ?&#39;, @rcid]<br>      @page_params[:search_extras] = {}<br>      @page_params[:search_extras][:rcid] = @rcid<br>    end<br>    if !@page_params[:search].blank?<br>      conditions &lt;&lt; [&#39;unit_resources.display_name LIKE ?&#39;, &quot;#{@page_params[:search]}%&quot;]<br>    end<br>    conditions = [conditions.map{|c| c.first}.join(&quot; AND &quot;)] +<br>        conditions.inject([]) {|params, c| params + c[1..-1]}<br>    conditions<br>  end<br><br>Now an example where the sql is the whole statement, as used in find_by_sql:<br><br>  def self.recently_edited(limit = 10, account_id = nil, state = nil)<br>    sql = []<br>    sql &lt;&lt; [&#39;SELECT TOP ? e.* FROM evacuations e<br>                 INNER JOIN event_logs el ON <a href="http://el.id/">el.id</a> = e.latest_event_log_id<br>                 INNER JOIN states s ON s.state_machinable_id = <a href="http://e.id/">e.id</a><br>                 INNER JOIN accounts a ON el.account_id = <a href="http://a.id/">a.id</a>&#39;, limit]<br>    sql &lt;&lt; [&#39; AND <a href="http://a.id/">a.id</a> = ?&#39;, account_id] if account_id<br>    sql &lt;&lt; [&#39; WHERE s.type = ?&#39;, state.to_s] if state<br>    sql &lt;&lt; [&#39; ORDER BY el.created_at DESC&#39;]<br>    sql = [sql.map{|s| s.first}.join] + sql.inject([]) {|p, s| p + s[1..-1]}<br>    Evacuation.find_by_sql(sql)<br>  end<br><br>Note that each relies on the format of the parts being [&#39;sql&#39;, params] where params may be 0 or more bind parameters from that sql.  The map and inject calls on the Array can then put together the proper array for the needed parameter binding.<br></div>
</div> <a name="NDQsiIgoQjYao3NMi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Example of intercepting the setting of an attribute, in this case, stripping anything that is not a digit:<br> <br>  def phone_number=(number)<br>    write_attribute(:phone_number, (number) ? number.gsub(/[^\d]/, &#39;&#39;) : nil)<br>  end<br><br>For reading the corresponding method is read_attribute.<br></div>
</div> <a name="NDRy_IgoQyZHjyNci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Using array tricks again to construct conditions gracefully when the values come from multi-select elements.  Here, :state, :last_edited_by, and :injury_cause_type come from multi-selects.  Keep in mind that on the html side the name of the elements is, for example, &quot;state[]&quot; so that rails knows to build an array of results for you.  Two things to notice here -- 1, the Array.new(#, string).join(&#39; or &#39;) to construct the disjunction inside parenthesis, and the grand array finally that wraps all the pieces into a big conjunction.<br><br>  def conditions_for_evacuations<br>    params[:order_by] = &#39;evacuations.updated_at&#39; if params[:order_by].blank?<br>    params[:order] = &#39;asc&#39; unless params[:order] &amp;&amp; params[:order] =~ /^asc|desc$/i<br><br>    conditions = []<br>    unless params[:updated_date_after].blank?<br>      conditions &lt;&lt; [&quot;evacuations.updated_at &gt;= ?&quot;, params[:updated_date_after]]<br>    end<br>    unless params[:updated_date_before].blank?<br>      conditions &lt;&lt; [&quot;evacuations.updated_at &lt;= ?&quot;, params[:updated_date_before]]<br>    end<br>    unless !params[:state] || params[:state].empty? || params[:state].include?(&#39;Any&#39;)<br>      cond = Array.new(params[:state].length, &#39;states.type = ?&#39;).join(&#39; or &#39;)<br>      conditions &lt;&lt; [&#39;(&#39; + cond + &#39;)&#39;] + params[:state]<br>    end<br>    unless !params[:last_edited_by] || params[:last_edited_by].empty? || params[:last_edited_by].include?(&#39;Any&#39;)<br>      cond = Array.new(params[:last_edited_by].length, &#39;accounts.login = ?&#39;).join(&#39; or &#39;)<br>      conditions &lt;&lt; [&#39;(&#39; + cond + &#39;)&#39;] + params[:last_edited_by]<br>    end<br>    unless !params[:injury_cause_type] || params[:injury_cause_type].empty? || params[:injury_cause_type].include?(&#39;Any&#39;$<br>      cond = Array.new(params[:injury_cause_type].length, &#39;evacuations.injury_cause_type = ?&#39;).join(&#39; or &#39;)<br>      conditions &lt;&lt; [&#39;(&#39; + cond + &#39;)&#39;] + params[:injury_cause_type]<br>    end<br><br>    unless conditions.empty?<br>      conditions = [conditions.map{|c| c.first}.join(&quot; and &quot;)] + conditions.inject([]){|p, c| p + c[1..-1]}<br>    else<br>      conditions = nil<br>    end<br><br>    conditions<br>  end<br></div>
</div> <a name="NDRCcIwoQkYWQ5dci"></a>
<div class="PubNote">
<div class="PubNoteContentArea"> With prototype, if you put returned JSON into an X-JSON header then the
prototype library will eval that content and return it as the second
parameter of the callback instead of you having to eval
transport.responseText.  I guess it is slightly cleaner code.  In rails
you might do this like this:<br><br>   def injury_cause_types<br>    injury_cause_types = InjuryCauseType.find(<br>        :all,<br>        :conditions =&gt; [&#39;code &gt;= ? AND code &lt;= ?&#39;, params[:low], params[:high]]$<br>        :order =&gt; &#39;code&#39;)             <br>    headers[&#39;X-JSON&#39;] = injury_cause_types.to_json<br>    render :nothing =&gt; true                               <br>  end<br></div>
</div> <a name="NDSLwIgoQ5ff15dci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Two examples of doing a delete of a pre-existing record in an association upon the setting of a new record.  Both of these relationships were polymorphic and both were coded up by Seth Ladd, first, the evacuations InjuryCause:<br><br>  # this code is all in evacuation<br>  belongs_to :injury_cause, :polymorphic =&gt; true<br><br>  # handles the deletion of the previous injury cause, if it exists<br>  # see also the alias_methods right after this method<br>  def set_injury_cause_with_destroy_existing(new_obj)<br>    self.injury_cause.destroy unless self.injury_cause.nil?<br>    set_injury_cause_without_destroy_existing(new_obj)<br>    self.cause_code = new_obj.cause_code<br>  end<br><br>  alias_method :set_injury_cause_without_destroy_existing, :injury_cause=<br>  alias_method :injury_cause=, :set_injury_cause_with_destroy_existing<br><br>Second, the evacuations State, and this is rather tricky because evac.state = new_state appears to create the state while still holding a reference to the old state, while the new state already has a reference to it:<br><br>  # this is in evacuation<br>  has_one :state, :as =&gt; :state_machinable, :dependent =&gt; :destroy<br><br>  # and the rest is in state:<br>  before_create :delete_existing_state<br>  belongs_to :state_machinable, :polymorphic =&gt; true<br><br>  private<br><br>  def delete_existing_state<br>    return if state_machinable.nil?<br>    # this works because at this point, the state_machinable doesn&#39;t know<br>    # about this new state, so state_machinable.state still refers to the<br>    # old state in the database<br>    state_machinable.state.destroy unless state_machinable.state.nil?<br>  end<br></div>
</div> <a name="NDQXAIwoQovWz5tci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Polymorphism in evacuation, used for both injury_cause and state.  First, in evacuation.rb:<br><br>  has_one :state, :as =&gt; :state_machinable, :dependent =&gt; :destroy<br>  # this links to sports_injury or machinery_tools_injury, etc<br>  belongs_to :injury_cause, :polymorphic =&gt; true<br><br>In state:<br><br>  abstract_class = true<br>  before_create :delete_existing_state<br>  belongs_to :state_machinable, :polymorphic =&gt; true<br><br>The actual states just subclass state:<br><br>  class ReadyToCodeState &lt; State<br>  end<br><br>State table has the following schema:<br><br>      t.column :type, :string<br>      t.column :state_machinable_id, :integer<br>      t.column :state_machinable_type, :string<br>      t.column :created_at, :timestamp<br><br>and in evacuation, the schema to hold the injury_cause:<br><br>      t.column :injury_cause_id, :integer<br>      t.column :injury_cause_type, :string<br></div>
</div> <a name="NDSfhIgoQ087w5tci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">How to freeze a gem into you rails, first you need gemsonrails installed:<br><br>  sudo gem install gemsonrails<br><br>Now that you have gemsonrails you can install a plugin and then freeze it:<br><br>  script/plugin install <a href="http://svn.codahale.com/rails_cov">http://svn.codahale.com/rails_cov</a><br>  gemsonrails<br>  rake gems:freeze GEM=rcov <br></div>
</div> <a name="NDRy_IgoQtK6059ci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">resources_attribute_group is a many to many join table between resource and attribute_group.  When a resource is deleted all of its resources_attribute_group records are deleted through a :dependent =&gt; :destroy   relationship.  We also want to delete the private attribute group specific to a single resource when these deletes occur.  So this is kind of like a :dependent =&gt; :destroy, but only if a condition is met.  This was handled in resources_attribute_group like this:<br><br>  def after_destroy<br>    # private attribute group is like a dependent<br>    attribute_group.destroy if !attribute_group.public<br>  end</div>
</div> <a name="NDSGcIwoQsvDD59ci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">cap deploy:cleanup will leave only the last 5 releases on the deployment server. </div>
</div> <a name="NDQXAIwoQnrOZ6Nci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">If you do this and #notice is not there you will get an error:<br><br>  page[:notice].hide<br><br>but you can trick it out like this:<br><br>page.select(&#39;div#notice&#39;).each {|d| d.hide} <br></div>
</div> <a name="NDQzjIgoQ8Ied6Nci"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Pure client side javascript can be written with a generator:<br><br>&lt;%= link_to_function(&#39;link text&#39;, nil) do |p|<br>  p.alert  &quot;whatever&quot;<br>  p.visual_effect :toggle_blind<br>  p[:identifier].replace_html &quot;show less&quot;<br>end %&gt; <br></div>
</div> <a name="NDRy_IgoQuqfKkdki"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Simple way to do button that works like link.  url_for is used to load the javascript:<br><br>&lt;%= button_to_function &#39;Personnel View&#39;, &quot;location.href = &#39;#{url_for(params_for(:action =&gt; &#39;index&#39;, :id =&gt; @<a href="http://unit.id">unit.id</a>))}&#39;&quot;, :class =&gt; &#39;submit&#39; %&gt;<br><br>I don&#39;t like it, but a lot of users apparently do.<br></div>
</div> <a name="NDRdkIgoQivOLsNki"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Validations that you write in the future are likely to break migrations that you wrote in the past...thus in migrations you might want to do something like this:<br><br>class UserActivation &lt; ActiveRecord::Migration<br>  class User &lt; ActiveRecord::Base; end<br>  def self.up<br>    ...<br> <br>to prevent such validations from running in your migration - that is you have a naked ActiveRecord::Base model.<br></div>
</div> <a name="NDRdkIgoQjbKRsNki"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Sometimes you may modify a model file in such a way that break previous migrations.  In some cases you can get away with making a pure copy of the model as described in the previous note.  Other times, it may be easier to override a single model method.  To do this you need to explicitly  import and then reopen the model like this in the migration:<br><br>require File.join(RAILS_ROOT, &#39;app/models/user.rb&#39;)<br>class User<br>  protected<br>  def setup_default_roles; end<br>end<br><br>class AddAdminUser &lt; ActiveRecord::Migration<br>  def self.up<br><br>Thus I&#39;ve stubbed out setup_default_roles so that it will not run.<br></div>
</div> <a name="NDQGkIwoQzaW87dki"></a>
<div class="PubNote">
<div class="PubNoteContentArea">In order to serve up a file but to control access to it you must hide it behind a controller.  In this case the send_file command can be used to deliver the file to the client.  This works, but an even faster and better way is to use a technique available on both apache and lighttpd using the X-Sendfile header.  When set the web server will handle the file serving automatically.</div>
</div> <a name="NDSGcIwoQ1IP3vNoi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Another complex migration that needed to add columns temporarily in order to do its work.  It had to create a new injury cause type and then copy some of the injuries that had been classified under a previous type to the new type:<br><br>   def self.up<br>    create_table :guns_explosives_not_iow_injuries do |t|<br>      t.column :injury_cause_type_id, :integer<br>      t.column :place_code_id, :integer<br>    end<br><br>    # own_iow_injuries with codes from 500-599 are being split out<br>    # into a new injury guns_explosives_not_iow_injuries, the following<br>    # sql 1. creates the new guns_explosives... records, 2. updates<br>    # evacuations to point at the new records, and 3. deletes the now<br>    # defunct own_iow_injuries records<br><br>    # temporary to facilitate the migration<br>    add_column :guns_explosives_not_iow_injuries, :evacuation_id, :integer<br>    add_column :guns_explosives_not_iow_injuries, :own_iow_injury_id, :integer<br><br>    # hmmmm, you can&#39;t seem to string these together in one execute separate by<br>    # semicolons...<br>    execute &lt;&lt;-EOSQL<br>        INSERT INTO guns_explosives_not_iow_injuries (evacuation_id, own_iow_injury_id, injury_cause_type_id, place_code_id)<br>            SELECT <a href="http://e.id">e.id</a>, <a href="http://oii.id">oii.id</a>, oii.injury_cause_type_id, oii.place_code_id FROM evacuations e<br>            INNER JOIN own_iow_injuries oii ON (e.injury_cause_id = <a href="http://oii.id">oii.id</a> AND e.injury_cause_type = &#39;OwnIowInjury&#39;)<br>            INNER JOIN injury_cause_types ict ON oii.injury_cause_type_id = <a href="http://ict.id">ict.id</a><br>            WHERE ict.code &gt; 499 AND ict.code &lt; 600;<br>    EOSQL<br>    execute &lt;&lt;-EOSQL<br>        UPDATE e<br>            SET e.injury_cause_id = <a href="http://g.id">g.id</a>, e.injury_cause_type = &#39;GunsExplosivesNotIowInjury&#39;<br>            FROM evacuations e, guns_explosives_not_iow_injuries g<br>            WHERE <a href="http://e.id">e.id</a> = g.evacuation_id;<br>    EOSQL<br>    execute &lt;&lt;-EOSQL<br>        DELETE FROM own_iow_injuries WHERE id IN<br>            (SELECT own_iow_injury_id FROM guns_explosives_not_iow_injuries);<br>    EOSQL<br><br>    # remove the temporary columns<br>    remove_column :guns_explosives_not_iow_injuries, :evacuation_id<br>    remove_column :guns_explosives_not_iow_injuries, :own_iow_injury_id<br><br>    # and own_iow_injuries no longer has a place code<br>    remove_column :own_iow_injuries, :place_code_id<br>  end</div>
</div> <a name="NDR_wIgoQ05eAvdoi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Sometimes you need to know the current controller which can easily be grabbed with controller.controller_name.  Other times you may have grouped controllers such as those grouped under admin and you want to, for example, style a link a certain way if you are in one of these controllers.  In this case if you have placed these controllers in an admin model you can check like this:<br><br>    if controller.controller_path =~ /^admin\// <br></div>
</div> <a name="NDSLwIgoQh5v189wi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Doing a migration when you have added an acts_as_list position column.  This example fixes both Quiz and Question which have becomes acts_as_list.  Quiz in the scope of QuizModule and Question in the scope of Quiz:<br><br>class FixQuizAndQuestionPosition &lt; ActiveRecord::Migration<br><br>  class Quiz &lt; ActiveRecord::Base; end<br>  class Question &lt; ActiveRecord::Base; end<br><br>  # Because acts_as_list and the position column have only recently been added<br>  # to the Quiz and Question models, the numbers are not correct.  This fixes<br>  # up the position and will put them in the order they were added.<br>  def self.up<br>    quizzes = Quiz.find(:all, :order =&gt; :quiz_module_id)<br>    previous_quiz_module_id = -1<br>    position = 1<br>    quizzes.each do |quiz|<br>      position = 1 if quiz.quiz_module_id != previous_quiz_module_id<br>      quiz.update_attribute(:position, position)<br>      position += 1<br>      previous_quiz_module_id = quiz.quiz_module_id<br>    end<br><br>    questions = Question.find(:all, :order =&gt; :quiz_id)<br>    previous_quiz_id = -1<br>    questions.each do |question|<br>      position = 1 if question.quiz_id != previous_quiz_id<br>      question.update_attribute(:position, position)<br>      position += 1<br>      previous_quiz_id = question.quiz_id<br>    end<br>  end<br><br>  def self.down<br>  end<br><br>end<br><br>Note that this is a bit simpler but requires models and associations and such.  In this case probably doesn&#39;t make a difference, but could in some cases:<br><br>#     QuizModule.find(:all).each do |qm|<br>#       qm.quizzes.inject(1) do |p, q|<br>#         q.update_attribute(:position, p)<br>#         p + 1<br>#       end<br>#     end<br><br>#     Quiz.find(:all).each do |q|<br>#       q.questions.inject(1) do |p, q|<br>#         q.update_attribute(:position, p)<br>#         p + 1<br>#       end<br>#     end<br></div>
</div> <a name="NDSLwIgoQ5dai_9wi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">As of now you can&#39;t assert_match against flash.now but you have a couple of other choices:<br><br>    # assert_match /Unable to create a password reset request for #{email}\./,<br>    #     flash.now[:notice]<br>    assert_match /Unable to create a password reset request for #{email}\./,<br>        @response.body<br>    assert_tag :tag =&gt; &#39;div&#39;,<br>        :child =&gt; /Unable to create a password reset request for #{email}\./</div>
</div> <a name="NDSDWIgoQmJOagN4i"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Example of how of a typical format for doing a plugin:<br><br>module ActsAsSomething<br><br>  def self.included(klass)<br>    klass.extend(Macros)<br>    super<br>  end<br><br>  module Macros<br><br>    def acts_as_something(options = {})<br>      extend ClassMethods<br>      include InstanceMethods<br>      configuration = {:something =&gt; &#39;something&#39;}<br>      configuration.update(options) if options.is_a?(Hash)<br><br>      class_eval &lt;&lt;-EOV<br>        def something_value<br>          &#39;#{configuration[:something]}&#39;<br>        end<br><br>        # an ActiveRecord actor might put some callback here<br>        # targetting instance methods defined below<br>      EOV<br>    end<br><br>  end<br><br>  module ClassMethods<br><br>    def class_method<br>      puts &quot;hello from the class method&quot;<br>    end<br><br>  end<br><br>  module InstanceMethods<br><br>    def instance_method<br>      puts &quot;hello from the instance method, value is #{something_value}&quot;<br>    end<br><br>  end<br><br>end<br><br>class MeWantingToActAsSomething<br><br>  include ActsAsSomething<br>  acts_as_something :something =&gt; &#39;Dog Food&#39;<br><br>end<br><br>me = MeWantingToActAsSomething.new<br>me.class.class_method<br>me.instance_method<br></div>
</div> <a name="NDQzjIgoQr5ix4eAi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">You can serve up something that can be opened in excel very easily by rendering out an xhtml table without the rails layout and setting the content type to to an excel content type.  Example of the controller action is here:<br><br>  def export<br>    @evacuations = Evacuation.find(:all,<br>                                   :include =&gt; [:state, {:latest_event_log =&gt; :account}],<br>                                   :conditions =&gt; conditions_for_evacuations,<br>                                   :order =&gt; &quot;#{params[:order_by]} #{params[:order]}&quot;)<br>    render :layout =&gt; false, :content_type =&gt; &#39;application/vnd.ms-excel&#39;<br>  end<br></div>
</div> <a name="NDQXAIwoQvK-d5OAi"></a>
<div class="PubNote">
<div class="PubNoteContentArea">This is a summary of how I used Railscast 74.  Question has many answers.  It is possible to create a new question and its answers in a single to create with the typical syntax:<br><br>  @quiz.questions.create(params[:question])<br>  @quiz.save!<br><br>If you set up the model for a question to do so, and set up the fields on the form correctly.  Here are two methods I put in the Question model:<br><br>  # Expects to receive answer attributes as a hash from id to<br>  # the attributes for that answer.  If this is a new unsaved<br>  # answer, the id will be n#, that is n followed by a # to<br>  # make it unique among the submitted answer attributes.<br>  def answer_attributes=(answer_hash)<br>    update_answers(answer_hash)<br>    new_answers_hash = answer_hash.select {|id, attributes| id =~ /^n/}<br>    new_answers_hash.each {|id, attributes| create_new_answer(attributes)}<br>  end<br><br>  private<br><br>  # Updates answers and also deletes answers not found in attribute_hash.<br>  # Answers will not be deleted if there is no correct answer among the<br>  # answers we are going to keep.<br>  def update_answers(answer_hash)<br>    has_correct = answer_hash.detect {|id, attributes| attributes[:correct] == &#39;1&#39;}<br>    answers.each do |answer|<br>      attributes = answer_hash[answer.id.to_s]<br>      if !attributes<br>        answer.update_attribute(:correct, false)<br>        answer.destroy if has_correct<br>      else<br>        answer.update_attributes(attributes)<br>      end<br>    end<br>  end<br><br>Now the fields on the form for answers, which include the question itself, can be set up with fields_for:<br><br>&lt;%  answer_id = (answer.new_record?) ? &quot;n#{answer_counter}&quot; : <a href="http://answer.id">answer.id</a> %&gt;<br>&lt;%  fields_for &quot;question[answer_attributes][#{answer_id}]&quot;, answer do |answer_form| -%&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;&lt;%= answer_counter + 1 %&gt;. &lt;%= answer_form.text_field :answer, :size =&gt; 40 %&gt;&lt;/td&gt;<br>        &lt;td align=&quot;center&quot;&gt;&lt;%= answer_form.check_box :correct %&gt;&lt;/td&gt;<br>        &lt;td&gt;&lt;%= link_to_function delete_image_tag, &#39;$(this).up(&quot;tr&quot;).remove()&#39; %&gt;&lt;/td&gt;<br>    &lt;/tr&gt;<br>&lt;%  end -%&gt;<br><br>Now this form works for both editing and creating answers, so it has to handle the ids correctly.  Look closely at the answer_id usage above and see how for a new record it puts n## for the id while for editing it is just ##.  In the answer_attributes= this is how the model tells if it is creating or editing an answer record.  Now I also made it so they could add unlimited answers using javascript.  This I had to hard code to accommodate for injecting unique n## record identifiers:<br><br>&lt;script&gt;<br>function addNewAnswer() {<br>  numAnswers++;<br>  var newAnswerTemplate = new Template(<br>      &#39;&lt;tr&gt;&#39; +<br>      &#39;  &lt;td&gt;#{numAnswers}. &lt;input id=&quot;question[answer_attributes][n#{numAnswers}]_answer&quot; name=&quot;question[answer_attributes][n#{numAnswers}][answer]&quot; size=&quot;40&quot; type=&quot;text&quot; /&gt;&#39; +<br>      &#39;  &lt;td align=&quot;center&quot;&gt;&lt;input id=&quot;question[answer_attributes][n#{numAnswers}]_correct&quot; name=&quot;question[answer_attributes][n#{numAnswers}][correct]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt;&lt;input name=&quot;question[answer_attributes][n#{numAnswers}][correct]&quot; type=&quot;hidden&quot; value=&quot;0&quot; /&gt;&lt;/td&gt;&#39; +<br>      &#39;  &lt;td&gt;&lt;a href=&quot;#&quot; onclick=&quot;$(this).up(\&#39;tr\&#39;).remove(); return false;&quot;&gt;&lt;img alt=&quot;Delete&quot; border=&quot;0&quot; src=&quot;/images/cross.png&quot; title=&quot;Delete&quot; /&gt;&lt;/a&gt;&lt;/td&gt;&#39; +<br>      &#39;&lt;/tr&gt;&#39;);<br>  new Insertion.Bottom(&#39;answers&#39;, newAnswerTemplate.evaluate({numAnswers: numAnswers}));<br>}<br>&lt;/script&gt;<br><br>This works pretty slick and full a full report look in the drsc project and specifically the question creating / editing process.<br></div>
</div> <a name="NDQO2IgoQz__jj-si"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Example of non conflicting routes for regular and admin with the same resource:<br><br>   map.resources :accounts, :collection =&gt; {:new_sign_up =&gt; :get, :sign_up =&gt; :post}<br>  map.resources :accounts, :controller =&gt; &#39;admin/accounts&#39;, :path_prefix =&gt; &#39;/admin&#39;, :name_prefix =&gt; &#39;admin_&#39;</div>
</div> <a name="NDSWSIwoQvd2JiK4j"></a>
<div class="PubNote">
<div class="PubNoteContentArea">Checkboxes don&#39;t send any value when they aren&#39;t selected.  This is a problem when using rails to allow multiple child models to be created within a single parent on a single form.  The checkboxes values won&#39;t end up being passed with the correct hash because the missing ones won&#39;t pass any value.<br><br>The work around is to do the value for the checkbox as a hidden field.  Then use a checkbox not tied directly to the model to change the value of that hidden field:<br><br>checkbox.onclick = function() {$(this).next(&quot;input[type=hidden]&quot;).value = (this.checked) ? &#39;yes&#39; : &#39;no&#39;;}<br>
&lt;%= f.hidden_field :whatever, value %&gt;<br><br>Now each record will send a &quot;yes&quot; or &quot;no&quot; answer for the field and the hashes will all line up correctly.<br></div>
</div></div></body></html>